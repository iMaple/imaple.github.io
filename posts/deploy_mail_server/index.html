<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=generator content="Hugo 0.136.5 with theme icarus"><meta name=google-site-verification content="Xu4Z5XZHTM0KZM9KXO7c23fo02SKezOMlFfUjuBoi5U"><meta name=baidu-site-verification content="hdV6VMPvvZ"><meta name=author content><meta name=description content="使用 Postfix, Dovecot, SQLite 搭建邮件服务器。
"><meta name=keywords content><title>搭建 SMTP 邮件服务器 - 枫林's Blog</title>
<meta name=application-name content="枫林's Blog"><meta name=msapplication-TileImage content="img/favicon.svg"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="枫林's Blog"><meta name=apple-mobile-web-app-status-bar-style content="default"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.imaple.net\/posts\/deploy_mail_server\/"},"headline":"枫林\u0027s Blog","image":[],"dataPublished":"2020-04-02T17:30:11\u002b08:00","dataModified":"2020-06-06T17:30:11\u002b08:00","author":{"@type":"Person","name":""},"publisher":{"@type":"Organization","name":"","logo":{"@type":"ImageObject","url":"publisher_logo"}},"description":"\u003cp\u003e使用 Postfix, Dovecot, SQLite 搭建邮件服务器。\u003c\/p\u003e"}</script><link rel=canonical href=https://blog.imaple.net/posts/deploy_mail_server/><link rel=alternate href=https://blog.imaple.net/index.xml title="枫林's Blog" type=application/rss+xml><link rel=icon href=/img/favicon.svg><link rel=stylesheet href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css><link rel=stylesheet href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/highlight.js/9.18.1/styles/atom-one-light.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel=stylesheet href=/css/default.css><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><script type=text/javascript src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js defer></script><link rel=stylesheet href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/cookieconsent/3.1.1/cookieconsent.min.css><script src="https://www.googletagmanager.com/gtag/js?id=G-6DQ842ZL2N" async></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6DQ842ZL2N")</script><script type=text/javascript src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/pace/1.0.2/pace.min.js></script></head><body class=is-3-column><nav class="navbar navbar-main"><div class=container><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href=/><img src=/img/logo.svg alt="搭建 SMTP 邮件服务器" height=28></a></div><div class=navbar-menu><div class=navbar-start><a class=navbar-item href=/>主页</a>
<a class=navbar-item href=/archives>归档</a>
<a class=navbar-item href=/categories>分类</a>
<a class=navbar-item href=/tags>标签</a>
<a class=navbar-item href=/about>关于</a></div><div class=navbar-end><a class="navbar-item is-hidden-tablet catalogue" title=目录 href=javascript:;><i class="fas fa-list-ul"></i>
</a><a class="navbar-item search" title=搜索 href=javascript:;><i class="fas fa-search"></i></a></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class=card><article class="card-content article" role=article><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class=level-left><span class=level-item><time datetime=2020-04-02T17:30:11+08:00 title=2020-04-02T17:30:11+08:00>2020-04-02
</time>发表
</span><span class=level-item><time datetime=2020-06-06T17:30:11+08:00 title=2020-06-06T17:30:11+08:00>2020-06-06
</time>更新
</span><span class=level-item><a class=link-muted href=/categories/%e9%83%a8%e7%bd%b2>部署</a>
</span><span class=level-item>6 分钟读完 (大约2679个字)</span>
<span class=level-item id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv>0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">搭建 SMTP 邮件服务器</h1><div class=content><p>使用 Postfix, Dovecot, SQLite 搭建邮件服务器。</p><p>名次解释：</p><ul><li><a href=https://zh.wikipedia.org/zh-cn/%E5%AE%8C%E6%95%B4%E7%B6%B2%E5%9F%9F%E5%90%8D%E7%A8%B1>FQDN</a>：<strong>完全限定域名</strong>。完整域名由<a href=https://zh.wikipedia.org/wiki/%E4%B8%BB%E6%A9%9F%E5%90%8D%E7%A8%B1>主机名称</a>与母域名两部分所组成。</li><li><a href=https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%90%91DNS>rDNS</a>：<strong>反向 DNS 解析</strong>。查询 DNS 来确定与 IP 地址关联的域名。</li></ul><p>约定：</p><ul><li>本文中所用域名为：example.com，FQDN 为 mail.example.com。</li></ul><h2 id=基本的准备>基本的准备</h2><p>依次完成如下工作：</p><ul><li>打开服务器相关端口：<ul><li>25 (SMTP)</li><li>465 (SMTPS)</li><li>143 (IMAP)</li><li>993 (IMAPS)</li></ul></li><li>设置一条 <strong>A 记录</strong>，使你的 FQDN 指向服务器 ip。</li><li>给你的域名设置一条 <strong>MX 记录</strong>。</li><li>给你的服务器设置<strong>反向 DNS 解析</strong>，使你的服务器 ip 指向你的 FQDN。</li><li>设置服务器主机名 (hostname) 为你的 FQDN。</li></ul><h2 id=获取域名-ssl-证书>获取域名 SSL 证书</h2><p>使用 <a href=https://github.com/acmesh-official/acme.sh>acme.sh</a> 签发即可。下面这篇文章可能会有一点帮助。</p><blockquote><p><a href=/posts/auto_acme/>利用 GitHub Action 实现 SSL 证书的自动续签</a></p></blockquote><p>将证书文件放置在如下位置：</p><p><code>/opt/ssl_certificate/fullchain.pem</code> 和 <code>/opt/ssl_certificate/key.pem</code></p><h2 id=安装软件包>安装软件包</h2><p>包括 Postfix、Dovecot、SQLite3 以及一些辅助性的软件。安装完成后，备份配置文件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># apt install postfix postfix-sqlite -y</span>
</span></span><span class=line><span class=cl><span class=c1># apt install dovecot-imapd dovecot-lmtpd dovecot-sqlite -y</span>
</span></span><span class=line><span class=cl><span class=c1># apt install sqlite3 -y</span>
</span></span><span class=line><span class=cl><span class=c1># apt install postgrey postfix-policyd-spf-python opendkim opendkim-tools fail2ban -y</span>
</span></span><span class=line><span class=cl><span class=c1># tar -czvf backup.tar.gz /etc/postfix /etc/dovecot /etc/opendkim.conf</span>
</span></span></code></pre></td></tr></table></div></div><p>顺便新建用户与用户组 <code>vmail</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># groupadd -g 5000 vmail</span>
</span></span><span class=line><span class=cl><span class=c1># useradd -g vmail -u 5000 vmail -d /var/mail -s /sbin/nologin</span>
</span></span><span class=line><span class=cl><span class=c1># chown -R vmail:vmail /var/mail</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=设置-dkim记录并配置-opendkim-服务>设置 DKIM记录并配置 opendkim 服务</h2><p>编辑配置文件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/opendkim.conf</span>
</span></span></code></pre></td></tr></table></div></div><p>在配置文件中找到如下几行，取消这几行的注释，并将 <code>simple</code> 改为 <code>relaxed/simple</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Canonicalization   simple
</span></span><span class=line><span class=cl>Mode               sv
</span></span><span class=line><span class=cl>SubDomains         no
</span></span></code></pre></td></tr></table></div></div><p>接着找到这一行 (<code>#ADSPAction continue</code>)，并将下面的内容添加到这行后面。如果没有找到这一行，只需要将下面的内容添加到这一行 (<code>SubDomains no</code>) 后面即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>AutoRestart         yes
</span></span><span class=line><span class=cl>AutoRestartRate     10/1M
</span></span><span class=line><span class=cl>Background          yes
</span></span><span class=line><span class=cl>DNSTimeout          5
</span></span><span class=line><span class=cl>SignatureAlgorithm  rsa-sha256
</span></span></code></pre></td></tr></table></div></div><p>将如下内容添加到文件末尾。在 Ubuntu 18.04 上，UserID 已经设置为 <code>opendkim</code>，无需重复添加。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>#OpenDKIM user
</span></span><span class=line><span class=cl># Remember to add user postfix to group opendkim
</span></span><span class=line><span class=cl>UserID             opendkim
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Map domains in From addresses to keys used to sign messages
</span></span><span class=line><span class=cl>KeyTable           refile:/etc/opendkim/key.table
</span></span><span class=line><span class=cl>SigningTable       refile:/etc/opendkim/signing.table
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Hosts to ignore when verifying signatures
</span></span><span class=line><span class=cl>ExternalIgnoreList  /etc/opendkim/trusted.hosts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># A set of internal hosts whose mail should be signed
</span></span><span class=line><span class=cl>InternalHosts       /etc/opendkim/trusted.hosts
</span></span></code></pre></td></tr></table></div></div><p>然后找到这一行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Socket                  local:/var/run/opendkim/opendkim.sock
</span></span></code></pre></td></tr></table></div></div><p>把它替换为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Socket                  local:/var/spool/postfix/opendkim/opendkim.sock
</span></span></code></pre></td></tr></table></div></div><p>保存文件并退出 vim。</p><p>执行如下命令，创建所需文件夹并编辑配置文件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># mkdir -p /etc/opendkim/keys/example.com</span>
</span></span><span class=line><span class=cl><span class=c1># vim /etc/opendkim/signing.table</span>
</span></span></code></pre></td></tr></table></div></div><p>写入如下内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>*@example.com    default._domainkey.example.com
</span></span></code></pre></td></tr></table></div></div><p>保存。注意上述内容中的域名要替换为你要部署的真实域名，后续不再提示。</p><p>编辑文件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/opendkim/key.table</span>
</span></span></code></pre></td></tr></table></div></div><p>写入如下内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>default._domainkey.example.com     example.com:default:/etc/opendkim/keys/example.com/default.private
</span></span></code></pre></td></tr></table></div></div><p>保存。注意，上面的内容为一整行，而不是两行分开。</p><p>编辑文件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/opendkim/trusted.hosts</span>
</span></span></code></pre></td></tr></table></div></div><p>写入如下内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>127.0.0.1
</span></span><span class=line><span class=cl>localhost
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*.example.com
</span></span></code></pre></td></tr></table></div></div><p>保存。</p><p>生成 opendkim key 并输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># opendkim-genkey -b 2048 -d example.com -D /etc/opendkim/keys/example.com -s default -v</span>
</span></span><span class=line><span class=cl><span class=c1># chown -R opendkim:opendkim /etc/opendkim</span>
</span></span><span class=line><span class=cl><span class=c1># cat /etc/opendkim/keys/example.com/default.txt</span>
</span></span></code></pre></td></tr></table></div></div><p>将输出的 opendkim key 按如下格式设置域名的 <strong>TXT 记录</strong>。注意删除记录值中多余的双引号。</p><blockquote><p>TXT default._domainkey v=DKIM1; K=rsa; p=xxxxxx;</p></blockquote><p>使用如下命令测试是否配置成功。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># opendkim-testkey -d example.com -s default -vvv</span>
</span></span></code></pre></td></tr></table></div></div><p>执行如下命令，使 Postfix 可以使用 opendkim 服务。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># gpasswd -a postfix opendkim</span>
</span></span><span class=line><span class=cl><span class=c1># mkdir /var/spool/postfix/opendkim</span>
</span></span><span class=line><span class=cl><span class=c1># chown opendkim:postfix /var/spool/postfix/opendkim</span>
</span></span><span class=line><span class=cl><span class=c1># systemctl restart opendkim</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=设置-spf-记录>设置 SPF 记录</h2><p>按如下格式设置域名的 <strong>TXT 记录</strong>。</p><blockquote><p>TXT @ v=spf1 mx ~all</p></blockquote><h2 id=设置-dmarc-记录>设置 DMARC 记录</h2><p>按如下格式设置域名的 <strong>TXT 记录</strong>。</p><blockquote><p>TXT _dmarc v=DMARC1; p=none; pct=100; sp=none; adkim=r; aspf=r; fo=1; rua=mailto:your_<a href=mailto:another_mail@gmail.com>another_mail@gmail.com</a>; ruf=mailto:your_<a href=mailto:another_mail@gmail.com>another_mail@gmail.com</a>;</p></blockquote><h2 id=配置拦截政策>配置拦截政策</h2><h3 id=白名单>白名单</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/postfix/rbl_override</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>dripemail2.com  OK          //drip.com
</span></span><span class=line><span class=cl>mlsend.com      OK          //mailerlite email marketing service
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># postmap /etc/postfix/rbl_override</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=heloehlo-主机名>HELO/EHLO 主机名</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/postfix/helo_access</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>optimus-webapi-prod-2.localdomain       OK
</span></span><span class=line><span class=cl>va-massmail-02.rakutenmarketing.com     OK
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># postmap /etc/postfix/helo_access</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=灰名单>灰名单</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/default/postgrey</span>
</span></span></code></pre></td></tr></table></div></div><p>找到下面这一行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>POSTGREY_OPTS=&#34;--inet=10023&#34;
</span></span></code></pre></td></tr></table></div></div><p>把它改为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>POSTGREY_OPTS=&#34;--inet=127.0.0.1:10023 --delay=60&#34;
</span></span></code></pre></td></tr></table></div></div><p>然后重启 postgrey 服务。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># systemctl restart postgrey</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=配置-fail2ban-工具>配置 Fail2ban 工具</h2><p>fail2ban 能有效防止常见的洪水攻击。</p><p>编辑 postfix 规则。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/fail2ban/jail.d/postfix.conf</span>
</span></span></code></pre></td></tr></table></div></div><p>内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[postfix]</span>
</span></span><span class=line><span class=cl><span class=na>enabled</span>     <span class=o>=</span> <span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>logpath</span>     <span class=o>=</span> <span class=s>%(syslog_mail)s</span>
</span></span><span class=line><span class=cl><span class=na>maxretry</span>    <span class=o>=</span> <span class=s>3</span>
</span></span><span class=line><span class=cl><span class=na>bantime</span>     <span class=o>=</span> <span class=s>1h</span>
</span></span><span class=line><span class=cl><span class=na>filter</span>      <span class=o>=</span> <span class=s>postfix</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[postfix-flood-attack]</span>
</span></span><span class=line><span class=cl><span class=na>enabled</span>     <span class=o>=</span> <span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>logpath</span>     <span class=o>=</span> <span class=s>%(syslog_mail)s</span>
</span></span><span class=line><span class=cl><span class=na>bantime</span>     <span class=o>=</span> <span class=s>1h</span>
</span></span><span class=line><span class=cl><span class=na>filter</span>      <span class=o>=</span> <span class=s>postfix-flood-attack</span>
</span></span><span class=line><span class=cl><span class=na>port</span>        <span class=o>=</span> <span class=s>smtp,smtps,imap,imaps,sieve</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 dovecot 规则。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/fail2ban/jail.d/dovecot.conf</span>
</span></span></code></pre></td></tr></table></div></div><p>内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[dovecot]</span>
</span></span><span class=line><span class=cl><span class=na>enabled</span>     <span class=o>=</span> <span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>logpath</span>     <span class=o>=</span> <span class=s>%(syslog_mail)s</span>
</span></span><span class=line><span class=cl><span class=na>maxretry</span>    <span class=o>=</span> <span class=s>3</span>
</span></span><span class=line><span class=cl><span class=na>bantime</span>     <span class=o>=</span> <span class=s>1h</span>
</span></span><span class=line><span class=cl><span class=na>filter</span>      <span class=o>=</span> <span class=s>dovecot</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 postfix 过滤器。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/fail2ban/filter.d/postfix-flood-attack.conf</span>
</span></span></code></pre></td></tr></table></div></div><p>内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[INCLUDES]</span>
</span></span><span class=line><span class=cl><span class=na>before</span> <span class=o>=</span> <span class=s>common.conf</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Definition]</span>
</span></span><span class=line><span class=cl><span class=na>_daemon</span> <span class=o>=</span> <span class=s>postfix(-\w+)?/(?:submission/|smtps/)?smtp[ds]</span>
</span></span><span class=line><span class=cl><span class=na>failregex</span> <span class=o>=</span> <span class=s>^%(__prefix_line)slost connection after AUTH from \S+\[&lt;HOST&gt;\]$</span>
</span></span><span class=line><span class=cl><span class=na>ignoreregex</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Init]</span>
</span></span><span class=line><span class=cl><span class=na>journalmatch</span> <span class=o>=</span> <span class=s>_SYSTEMD_UNIT=postfix.service</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。重启 fail2ban 服务。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># systemctl restart fail2ban</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=创建数据库表>创建数据库表</h2><p>创建并调用 sqlite 数据库。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># sqlite3 /etc/postfix/postfix.sqlite</span>
</span></span></code></pre></td></tr></table></div></div><p>调整格式化输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sqlite&gt; .header on
</span></span><span class=line><span class=cl>sqlite&gt; .mode column
</span></span><span class=line><span class=cl>sqlite&gt; .timer on
</span></span></code></pre></td></tr></table></div></div><p>依次执行如下 SQL 语句，创建数据库表。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>domains</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>domain</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>UNIQUE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>description</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>active</span><span class=w> </span><span class=n>tinyint</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>username</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>password</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>domain_id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>quota</span><span class=w> </span><span class=nb>bigint</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;0&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>created</span><span class=w> </span><span class=n>datetime</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=p>(</span><span class=n>datetime</span><span class=p>(</span><span class=s1>&#39;now&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;localtime&#39;</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>active</span><span class=w> </span><span class=n>tinyint</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=p>(</span><span class=n>domain_id</span><span class=p>)</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>domains</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>aliases</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>domain_id</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>source</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>destination</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>active</span><span class=w> </span><span class=n>tinyint</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=p>(</span><span class=n>domain_id</span><span class=p>)</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>domains</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>domains</span><span class=w> </span><span class=p>(</span><span class=k>domain</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;example.com&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=p>(</span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>password</span><span class=p>,</span><span class=w> </span><span class=n>domain_id</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;i&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;{CRYPT}$2y$05$....&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>aliases</span><span class=w> </span><span class=p>(</span><span class=n>domain_id</span><span class=p>,</span><span class=w> </span><span class=k>source</span><span class=p>,</span><span class=w> </span><span class=n>destination</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;aliase@example.com&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;i@example.com&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>注：邮箱用户密码可暂时使用如下命令生成：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># doveadm pw -p &#34;passwd&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=配置-postfix>配置 Postfix</h2><p>编辑 <code>/etc/postfix/main.cf</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/postfix/main.cf</span>
</span></span></code></pre></td></tr></table></div></div><p>替换为如下内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1>#----- General -----</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>myhostname</span> <span class=o>=</span> <span class=s>mail.example.com</span>
</span></span><span class=line><span class=cl><span class=na>myorigin</span> <span class=o>=</span> <span class=s>/etc/mailname</span>
</span></span><span class=line><span class=cl><span class=na>mydestination</span> <span class=o>=</span> <span class=s>localhost</span>
</span></span><span class=line><span class=cl><span class=na>relayhost</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=na>mynetworks</span> <span class=o>=</span> <span class=s>127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128</span>
</span></span><span class=line><span class=cl><span class=na>mailbox_size_limit</span> <span class=o>=</span> <span class=s>0</span>
</span></span><span class=line><span class=cl><span class=na>recipient_delimiter</span> <span class=o>=</span> <span class=s>+</span>
</span></span><span class=line><span class=cl><span class=na>inet_interfaces</span> <span class=o>=</span> <span class=s>all</span>
</span></span><span class=line><span class=cl><span class=na>inet_protocols</span> <span class=o>=</span> <span class=s>all</span>
</span></span><span class=line><span class=cl><span class=na>mynetworks_style</span> <span class=o>=</span> <span class=s>host</span>
</span></span><span class=line><span class=cl><span class=na>append_dot_mydomain</span> <span class=o>=</span> <span class=s>no</span>
</span></span><span class=line><span class=cl><span class=na>readme_directory</span> <span class=o>=</span> <span class=s>no</span>
</span></span><span class=line><span class=cl><span class=na>compatibility_level</span> <span class=o>=</span> <span class=s>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#----- SMTPD parameters -----</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>biff</span> <span class=o>=</span> <span class=s>no</span>
</span></span><span class=line><span class=cl><span class=c1>#delay_warning_time = 4h</span>
</span></span><span class=line><span class=cl><span class=na>disable_vrfy_command</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>strict_rfc821_envelopes</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=c1>#smtputf8_enable = no</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>smtpd_banner</span> <span class=o>=</span> <span class=s>$myhostname ESMTP $mail_name (Ubuntu)</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_delay_reject</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_helo_required</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_timeout</span> <span class=o>=</span> <span class=s>30s</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_recipient_limit</span> <span class=o>=</span> <span class=s>40</span>
</span></span><span class=line><span class=cl><span class=c1>#smtpd_etrn_restrictions = reject</span>
</span></span><span class=line><span class=cl><span class=c1>#smtpd_reject_unlisted_sender = yes</span>
</span></span><span class=line><span class=cl><span class=c1>#smtpd_reject_unlisted_recipient = yes</span>
</span></span><span class=line><span class=cl><span class=c1>#smtpd_hard_error_limit = 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>smtp_always_send_ehlo</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>smtp_helo_timeout</span> <span class=o>=</span> <span class=s>15s</span>
</span></span><span class=line><span class=cl><span class=na>smtp_rcpt_timeout</span> <span class=o>=</span> <span class=s>15s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#maximal_queue_lifetime = 1d</span>
</span></span><span class=line><span class=cl><span class=c1>#bounce_queue_lifetime = 1d</span>
</span></span><span class=line><span class=cl><span class=na>minimal_backoff_time</span> <span class=o>=</span> <span class=s>180s</span>
</span></span><span class=line><span class=cl><span class=na>maximal_backoff_time</span> <span class=o>=</span> <span class=s>3h</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#----- TLS parameters -----</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_use_tls</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_auth_only</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_cert_file</span> <span class=o>=</span> <span class=s>/opt/ssl_certificate/fullchain.pem</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_key_file</span> <span class=o>=</span> <span class=s>/opt/ssl_certificate/key.pem</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_ciphers</span> <span class=o>=</span> <span class=s>high</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_security_level</span> <span class=o>=</span> <span class=s>may</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_protocols</span> <span class=o>=</span> <span class=s>!SSLv2, !SSLv3, !TLSv1, !TLSv1.1</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_mandatory_protocols</span> <span class=o>=</span> <span class=s>!SSLv2, !SSLv3, !TLSv1, !TLSv1.1</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_loglevel</span> <span class=o>=</span> <span class=s>0</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_session_cache_database</span> <span class=o>=</span> <span class=s>btree:${data_directory}/smtpd_scache</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_tls_received_header</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>smtp_tls_security_level</span> <span class=o>=</span> <span class=s>may</span>
</span></span><span class=line><span class=cl><span class=na>smtp_tls_protocols</span> <span class=o>=</span> <span class=s>!SSLv2, !SSLv3, !TLSv1, !TLSv1.1</span>
</span></span><span class=line><span class=cl><span class=na>smtp_tls_mandatory_protocols</span> <span class=o>=</span> <span class=s>!SSLv2, !SSLv3, !TLSv1, !TLSv1.1</span>
</span></span><span class=line><span class=cl><span class=na>smtp_tls_loglevel</span> <span class=o>=</span> <span class=s>0</span>
</span></span><span class=line><span class=cl><span class=na>smtp_tls_session_cache_database</span> <span class=o>=</span> <span class=s>btree:${data_directory}/smtp_scache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#----- SASL parameters -----</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_sasl_type</span> <span class=o>=</span> <span class=s>dovecot</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_sasl_path</span> <span class=o>=</span> <span class=s>private/auth</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_sasl_auth_enable</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_sasl_security_options</span> <span class=o>=</span> <span class=s>noanonymous</span>
</span></span><span class=line><span class=cl><span class=c1>#smtpd_sasl_local_domain =</span>
</span></span><span class=line><span class=cl><span class=c1>#smtpd_sasl_authenticated_header = no</span>
</span></span><span class=line><span class=cl><span class=c1>#broken_sasl_auth_clients = no</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#----- Virtual domains -----</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>alias_maps</span> <span class=o>=</span> <span class=s>hash:/etc/aliases</span>
</span></span><span class=line><span class=cl><span class=na>alias_database</span> <span class=o>=</span> <span class=s>hash:/etc/aliases</span>
</span></span><span class=line><span class=cl><span class=na>virtual_transport</span> <span class=o>=</span> <span class=s>lmtp:unix:private/dovecot-lmtp</span>
</span></span><span class=line><span class=cl><span class=na>virtual_mailbox_domains</span> <span class=o>=</span> <span class=s>sqlite:/etc/postfix/sqlite_mailbox_domains.cf</span>
</span></span><span class=line><span class=cl><span class=na>virtual_mailbox_maps</span> <span class=o>=</span> <span class=s>sqlite:/etc/postfix/sqlite_mailbox_maps.cf</span>
</span></span><span class=line><span class=cl><span class=na>virtual_alias_maps</span> <span class=o>=</span> <span class=s>sqlite:/etc/postfix/sqlite_alias_maps.cf</span>
</span></span><span class=line><span class=cl><span class=c1>#virtual_uid_maps = static:5000</span>
</span></span><span class=line><span class=cl><span class=c1>#virtual_gid_maps = static:5000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#----- Restrictions -----</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>smtpd_recipient_restrictions</span> <span class=o>=</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  permit_mynetworks,
</span></span></span><span class=line><span class=cl><span class=s>  permit_sasl_authenticated,
</span></span></span><span class=line><span class=cl><span class=s>  reject_non_fqdn_recipient,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unknown_recipient_domain,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unlisted_recipient,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unauth_destination,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unauth_pipelining,
</span></span></span><span class=line><span class=cl><span class=s>  check_policy_service unix:private/policyd-spf,
</span></span></span><span class=line><span class=cl><span class=s>  check_policy_service inet:127.0.0.1:10023,
</span></span></span><span class=line><span class=cl><span class=s>  check_client_access hash:/etc/postfix/rbl_override,
</span></span></span><span class=line><span class=cl><span class=s>  reject_rhsbl_helo dbl.spamhaus.org,
</span></span></span><span class=line><span class=cl><span class=s>  reject_rhsbl_reverse_client dbl.spamhaus.org,
</span></span></span><span class=line><span class=cl><span class=s>  reject_rhsbl_sender dbl.spamhaus.org</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_sender_restrictions</span> <span class=o>=</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  permit_mynetworks,
</span></span></span><span class=line><span class=cl><span class=s>  permit_sasl_authenticated,
</span></span></span><span class=line><span class=cl><span class=s>  reject_sender_login_mismatch,
</span></span></span><span class=line><span class=cl><span class=s>  reject_non_fqdn_sender,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unknown_sender_domain,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unknown_reverse_client_hostname,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unknown_client_hostname,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unauth_pipelining</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_helo_restrictions</span> <span class=o>=</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  permit_mynetworks,
</span></span></span><span class=line><span class=cl><span class=s>  permit_sasl_authenticated,
</span></span></span><span class=line><span class=cl><span class=s>  check_helo_access hash:/etc/postfix/helo_access,
</span></span></span><span class=line><span class=cl><span class=s>  reject_invalid_helo_hostname,
</span></span></span><span class=line><span class=cl><span class=s>  reject_non_fqdn_helo_hostname,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unknown_helo_hostname</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_relay_restrictions</span> <span class=o>=</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  permit_mynetworks,
</span></span></span><span class=line><span class=cl><span class=s>  permit_sasl_authenticated,
</span></span></span><span class=line><span class=cl><span class=s>  defer_unauth_destination,
</span></span></span><span class=line><span class=cl><span class=s>  check_helo_access hash:/etc/postfix/helo_access,
</span></span></span><span class=line><span class=cl><span class=s>  reject_invalid_helo_hostname,
</span></span></span><span class=line><span class=cl><span class=s>  reject_non_fqdn_helo_hostname,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unknown_helo_hostname</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_client_restrictions</span> <span class=o>=</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  permit_mynetworks,
</span></span></span><span class=line><span class=cl><span class=s>  permit_sasl_authenticated,
</span></span></span><span class=line><span class=cl><span class=s>  reject_unknown_client_hostname,
</span></span></span><span class=line><span class=cl><span class=s>  reject_rbl_client bl.spamcop.net,
</span></span></span><span class=line><span class=cl><span class=s>  reject_rbl_client zen.spamhaus.org,
</span></span></span><span class=line><span class=cl><span class=s>  reject_rbl_client blackholes.easynet.nl</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_data_restrictions</span> <span class=o>=</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  reject_unauth_pipelining</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#----- policyd-spf -----</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>policyd-spf_time_limit</span> <span class=o>=</span> <span class=s>3600</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#----- Opendkim -----</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>milter_default_action</span> <span class=o>=</span> <span class=s>accept</span>
</span></span><span class=line><span class=cl><span class=na>milter_protocol</span> <span class=o>=</span> <span class=s>6</span>
</span></span><span class=line><span class=cl><span class=na>smtpd_milters</span> <span class=o>=</span> <span class=s>local:/opendkim/opendkim.sock</span>
</span></span><span class=line><span class=cl><span class=na>non_smtpd_milters</span> <span class=o>=</span> <span class=s>$smtpd_milters</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 <code>/etc/postfix/master.cf</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/postfix/master.cf</span>
</span></span></code></pre></td></tr></table></div></div><p>取消 <code>smtps</code> 小节的注释，并调整为如下几行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>smtps     inet  n       -       y       -       -       smtpd</span>
</span></span><span class=line><span class=cl>  <span class=na>-o syslog_name</span><span class=o>=</span><span class=s>postfix/smtps
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_tls_security_level=encrypt
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_tls_wrappermode=yes
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_sasl_auth_enable=yes
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_sasl_type=dovecot
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_sasl_path=private/auth
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_sasl_security_options=noanonymous
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_sasl_local_domain=$myhostname
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_reject_unlisted_recipient=no
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_sender_login_maps=sqlite:/etc/postfix/sqlite_mailbox_maps.cf
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_sender_restrictions=reject_sender_login_mismatch
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_client_restrictions=permit_sasl_authenticated,reject
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
</span></span></span><span class=line><span class=cl><span class=s>  -o smtpd_recipient_restrictions=reject_non_fqdn_recipient,reject_unknown_recipient_domain,permit_mynetworks,permit_sasl_authenticated,reject
</span></span></span><span class=line><span class=cl><span class=s>  -o milter_macro_daemon_name=ORIGINATING</span>
</span></span></code></pre></td></tr></table></div></div><p>在文件末尾添加下面几行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>policyd-spf  unix  -       n       n       -       0       spawn</span>
</span></span><span class=line><span class=cl>  <span class=na>user</span><span class=o>=</span><span class=s>policyd-spf argv=/usr/bin/policyd-spf</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 <code>sqlite_mailbox_domains.cf</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/postfix/sqlite_mailbox_domains.cf</span>
</span></span></code></pre></td></tr></table></div></div><p>内容为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>dbpath</span> <span class=o>=</span> <span class=s>/etc/postfix/postfix.sqlite</span>
</span></span><span class=line><span class=cl><span class=na>query</span> <span class=o>=</span> <span class=s>SELECT domain FROM domains WHERE domain=&#39;%s&#39;</span>
</span></span><span class=line><span class=cl><span class=na>result_format</span> <span class=o>=</span> <span class=s>%s</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 <code>sqlite_mailbox_maps.cf</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/postfix/sqlite_mailbox_maps.cf</span>
</span></span></code></pre></td></tr></table></div></div><p>内容为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>dbpath</span> <span class=o>=</span> <span class=s>/etc/postfix/postfix.sqlite</span>
</span></span><span class=line><span class=cl><span class=na>query</span> <span class=o>=</span> <span class=s>SELECT username||&#39;@&#39;|| FROM users INNER JOIN domains on users.domain_id=domains.id WHERE username=&#39;%u&#39;</span>
</span></span><span class=line><span class=cl><span class=na>result_format</span> <span class=o>=</span> <span class=s>%s</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 <code>sqlite_alias_maps.cf</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/postfix/sqlite_alias_maps.cf</span>
</span></span></code></pre></td></tr></table></div></div><p>内容为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>dbpath</span> <span class=o>=</span> <span class=s>/etc/postfix/postfix.sqlite</span>
</span></span><span class=line><span class=cl><span class=na>query</span> <span class=o>=</span> <span class=s>SELECT destination FROM aliases WHERE source = &#39;%s&#39;</span>
</span></span><span class=line><span class=cl><span class=na>result_format</span> <span class=o>=</span> <span class=s>%s</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=配置-dovecot>配置 Dovecot</h2><p>编辑 <code>/etc/dovecot/dovecot.conf</code></p><p>将 <code>protocols = imap lmtp</code> 添加到 <code># Enable installed protocols</code> 的后面。</p><p>保存。然后编辑 <code>/etc/dovecot/conf.d/10-auth.conf</code></p><p>修改文件内容为如下几行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>disable_plaintext_auth</span> <span class=o>=</span> <span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>auth_mechanisms</span> <span class=o>=</span> <span class=s>plain login</span>
</span></span><span class=line><span class=cl><span class=na>!include auth-sql.conf.ext</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 <code>/etc/dovecot/conf.d/10-mail.conf</code></p><p>修改文件内容为如下几行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>mail_location</span> <span class=o>=</span> <span class=s>maildir:/var/mail/%d/%n/</span>
</span></span><span class=line><span class=cl><span class=na>mail_privileged_group</span> <span class=o>=</span> <span class=s>mail</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 <code>/etc/dovecot/conf.d/10-master.conf</code></p><p>编辑 <code>service auth</code> 块为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>service</span> <span class=s>auth</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kn>unix_listener</span> <span class=s>auth-userdb</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>mode</span> <span class=p>=</span> <span class=mi>0600</span>
</span></span><span class=line><span class=cl>    <span class=s>user</span> <span class=p>=</span> <span class=s>vmail</span>
</span></span><span class=line><span class=cl>    <span class=s>group</span> <span class=p>=</span> <span class=s>vmail</span>
</span></span><span class=line><span class=cl>  <span class=err>}</span>
</span></span><span class=line><span class=cl>  <span class=s>unix_listener</span> <span class=s>/var/spool/postfix/private/auth</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>mode</span> <span class=p>=</span> <span class=mi>0660</span>
</span></span><span class=line><span class=cl>    <span class=s>user</span> <span class=p>=</span> <span class=s>postfix</span>
</span></span><span class=line><span class=cl>    <span class=s>group</span> <span class=p>=</span> <span class=s>postfix</span>
</span></span><span class=line><span class=cl>  <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span></code></pre></td></tr></table></div></div><p>编辑 <code>service lmtp</code> 块为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>service</span> <span class=s>lmtp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kn>unix_listener</span> <span class=s>/var/spool/postfix/private/dovecot-lmtp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>mode</span> <span class=p>=</span> <span class=mi>0600</span>
</span></span><span class=line><span class=cl>    <span class=s>user</span> <span class=p>=</span> <span class=s>postfix</span>
</span></span><span class=line><span class=cl>    <span class=s>group</span> <span class=p>=</span> <span class=s>postfix</span>
</span></span><span class=line><span class=cl>  <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span></code></pre></td></tr></table></div></div><p>编辑 <code>service auth-worker</code> 块为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>service</span> <span class=s>auth-worker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>#user = vmail
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 <code>/etc/dovecot/conf.d/10-ssl.conf</code></p><p>修改文件内容为如下几行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>ssl</span> <span class=o>=</span> <span class=s>required</span>
</span></span><span class=line><span class=cl><span class=na>ssl_cert</span> <span class=o>=</span> <span class=s>&lt;/opt/ssl_certificate/fullchain.pem</span>
</span></span><span class=line><span class=cl><span class=na>ssl_key</span> <span class=o>=</span> <span class=s>&lt;/opt/ssl_certificate/key.pem</span>
</span></span><span class=line><span class=cl><span class=na>ssl_min_protocol</span> <span class=o>=</span> <span class=s>TLSv1.2</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 <code>/etc/dovecot/conf.d/auth-sql.conf.ext</code></p><p>修改文件内容为如下几行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>passdb</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kn>driver</span> <span class=p>=</span> <span class=s>sql</span>
</span></span><span class=line><span class=cl>  <span class=s>args</span> <span class=p>=</span> <span class=s>/etc/dovecot/dovecot-sql.conf.ext</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl><span class=s>userdb</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kn>driver</span> <span class=p>=</span> <span class=s>static</span>
</span></span><span class=line><span class=cl>  <span class=s>args</span> <span class=p>=</span> <span class=s>uid=vmail</span> <span class=s>gid=vmail</span> <span class=s>home=/var/mail/%d/%n</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span></code></pre></td></tr></table></div></div><p>保存。然后编辑 <code>/etc/dovecot/dovecot-sql.conf.ext</code></p><p>修改文件内容为如下几行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>driver</span> <span class=o>=</span> <span class=s>sqlite</span>
</span></span><span class=line><span class=cl><span class=na>connect</span> <span class=o>=</span> <span class=s>/etc/postfix/postfix.sqlite</span>
</span></span><span class=line><span class=cl><span class=na>default_pass_scheme</span> <span class=o>=</span> <span class=s>SHA512-CRYPT</span>
</span></span><span class=line><span class=cl><span class=na>password_query</span> <span class=o>=</span> <span class=s>\
</span></span></span><span class=line><span class=cl><span class=s>  SELECT username, domain, password \
</span></span></span><span class=line><span class=cl><span class=s>  FROM users INNER JOIN domains ON users.domain_id=domains.id \
</span></span></span><span class=line><span class=cl><span class=s>  WHERE username = &#39;%n&#39; AND domain = &#39;%d&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=测试>测试</h2><p><a href=https://www.mail-tester.com/>Newsletters spam test</a></p><h2 id=参考>参考</h2><ul><li><a href=https://www.linuxbabe.com/mail-server/secure-email-server-ubuntu-16-04-postfix-dovecot>Install Dovecot IMAP server on Ubuntu & Enable TLS Encryption</a></li><li><a href=https://wiki.mattrude.com/Installing_Postfix_on_Ubuntu_using_SQLite>Installing Postfix on Ubuntu using SQLite</a></li><li><a href=https://workaround.org/ispmail>ISPmail tutorials</a></li><li><a href=https://www.linode.com/docs/email/postfix/email-with-postfix-dovecot-and-mysql/>Email with Postfix, Dovecot, and MySQL</a></li><li><a href=https://ubuverse.com/setting-up-your-own-mail-server-on-ubuntu/>Setting Up Your Own Mail Server on Ubuntu</a></li></ul><p>以上。</p><hr></div><div class="article-licensing box"><div class=licensing-title><p>搭建 SMTP 邮件服务器</p><p><a href=https://blog.imaple.net/posts/deploy_mail_server/>https://blog.imaple.net/posts/deploy_mail_server/</a></p></div><div class="licensing-meta level is-mobile"><div class=level-left><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-04-02</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-06-06</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a title="CC BY-NC 4.0" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p></div></div></div></div></div><div class="article-tags size-small mb-4"><span class=mr-2>#</span><a class="link-muted mr-2" href=/tags/mail rel=tag>mail</a><a class="link-muted mr-2" href=/tags/sqlite rel=tag>sqlite</a><a class="link-muted mr-2" href=/tags/TLS rel=tag>TLS</a></div></article></div><nav class="post-navigation mt-4 level is-mobile"><div class=level-start><a class="article-nav-prev level level-item link-muted" href=https://blog.imaple.net/posts/deploy_teamspeak3/><i class="level-item fas fa-chevron-left"></i>
<span class=level-item>搭建 Teamspeak3 服务器</span></a></div><div class=level-end><a class="article-nav-next level level-item link-muted" href=https://blog.imaple.net/posts/about_minecraft/><span class=level-item>Minecraft 相关</span>
<i class="level-item fas fa-chevron-right"></i></a></div></nav><div class=card><div class=card-content><h3 class="title is-5">评论</h3><div id=comment-container></div><link rel=stylesheet href=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.6.2/gitalk.min.css><script type=text/javascript src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gitalk/1.6.2/gitalk.min.js></script><script>const gitalk=new Gitalk({id:"390074909d0bf50f43d33f27543ef655",repo:"imaple.github.io",owner:"iMaple",clientID:"376411df254e5e681ea6",clientSecret:"69fd9b70865e7a062eb1ce4da8a2fb509023df89",admin:["iMaple"],createIssueManually:!1,distractionFreeMode:!1,perPage:10,pagerDirection:"last",enableHotKey:!0});gitalk.render("comment-container")</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen order-1"><div class="card widget" data-type=profile><div class=card-content><nav class=level><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src=/img/avatar.webp alt=iMaple></figure><p class="title is-size-4 is-block" style=line-height:inherit>iMaple</p><p class="is-size-6 is-block">说有意义的话，做有意义的事</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i>
<span>地球, 太阳系</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class=heading>文章</p><a href=/archives><p class=title>11</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class=heading>分类</p><a href=/categories><p class=title>6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class=heading>标签</p><a href=/tags><p class=title>12</p></a></div></div></nav><div class=level><a class="level-item button is-primary is-rounded" href=https://github.com/imaple target=_blank rel=noopener>关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" title=Gitlab href=https://gitlab.com/imaple target=_blank rel=noopener><i class="fab fa-gitlab"></i>
</a><a class="level-item button is-transparent is-marginless" title=Telegram href=https://telegram.me/imaple target=_blank rel=noopener><i class="fab fa-telegram"></i>
</a><a class="level-item button is-transparent is-marginless" title=Mail href=mailto:imaple.org@gmail.com target=_blank rel=noopener><i class="fas fa-envelope"></i>
</a><a class="level-item button is-transparent is-marginless" title=RSS href=/index.xml target=_blank rel=noopener><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id=toc data-type=toc><div class=card-content><div class=menu><h3 class=menu-label>目录</h3><nav id=TableOfContents><ul><li><a href=#基本的准备>基本的准备</a></li><li><a href=#获取域名-ssl-证书>获取域名 SSL 证书</a></li><li><a href=#安装软件包>安装软件包</a></li><li><a href=#设置-dkim记录并配置-opendkim-服务>设置 DKIM记录并配置 opendkim 服务</a></li><li><a href=#设置-spf-记录>设置 SPF 记录</a></li><li><a href=#设置-dmarc-记录>设置 DMARC 记录</a></li><li><a href=#配置拦截政策>配置拦截政策</a><ul><li><a href=#白名单>白名单</a></li><li><a href=#heloehlo-主机名>HELO/EHLO 主机名</a></li><li><a href=#灰名单>灰名单</a></li></ul></li><li><a href=#配置-fail2ban-工具>配置 Fail2ban 工具</a></li><li><a href=#创建数据库表>创建数据库表</a></li><li><a href=#配置-postfix>配置 Postfix</a></li><li><a href=#配置-dovecot>配置 Dovecot</a></li><li><a href=#测试>测试</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><style>.menu-list>li>a.is-active+.menu-list{display:block}.menu-list>li>a+.menu-list{display:none}</style><script type=text/javascript src=/js/toc.js defer></script></div><div class="card widget" data-type=categories><div class=card-content><div class=menu><h3 class=menu-label>分类</h3><ul class=menu-list><li><a class="level is-mobile" href=/categories/%e5%a4%87%e5%bf%98><span class=level-start><span class=level-item>备忘</span>
</span><span class=level-end><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href=/categories/%e6%8a%80%e6%9c%af><span class=level-start><span class=level-item>技术</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href=/categories/%e6%97%a5%e5%b8%b8><span class=level-start><span class=level-item>日常</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href=/categories/%e6%b8%b8%e6%88%8f><span class=level-start><span class=level-item>游戏</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href=/categories/%e7%ae%97%e6%b3%95><span class=level-start><span class=level-item>算法</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href=/categories/%e9%83%a8%e7%bd%b2><span class=level-start><span class=level-item>部署</span>
</span><span class=level-end><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type=tags><div class=card-content><div class=menu><h3 class=menu-label>标签</h3><div class="field is-grouped is-grouped-multiline"><div class=control><a class="tags has-addons" href=/tags/algorithm><span class=tag>algorithm</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/certificate><span class=tag>certificate</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/don%27t%20ask><span class=tag>don't ask</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/git><span class=tag>git</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/hugo><span class=tag>hugo</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/mail><span class=tag>mail</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/minecraft><span class=tag>minecraft</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/nginx><span class=tag>nginx</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/sqlite><span class=tag>sqlite</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/teamspeak3><span class=tag>teamspeak3</span>
<span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/tls><span class=tag>tls</span>
<span class=tag>3</span></a></div><div class=control><a class="tags has-addons" href=/tags/workflow><span class=tag>workflow</span>
<span class=tag>2</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type=recent-posts><div class=card-content><h3 class=menu-label>最新文章</h3><article class=media><figure class=media-left><a class=image href=https://blog.imaple.net/posts/auto_hugo/><img src=https://raw.githubusercontent.com/iMaple/imaple.github.io/assets/img/06d0c0fa95f0fa681f61aa1ba0c97ec7-53324e.webp alt="利用 GitHub Action 自动部署博客"></a></figure><div class=media-content><p class=date><time datetime=2020-09-11T10:19:18+08:00>2020-09-11</time></p><p class=title><a href=https://blog.imaple.net/posts/auto_hugo/>利用 GitHub Action 自动部署博客</a></p><p class=categories><a href=/categories/%e9%83%a8%e7%bd%b2>部署</a></p></div></article><article class=media><div class=media-content><p class=date><time datetime=2020-08-26T18:37:45+08:00>2020-08-26</time></p><p class=title><a href=https://blog.imaple.net/posts/deploy_kms/>关于 Kms 服务器</a></p><p class=categories><a href=/categories/%e5%a4%87%e5%bf%98>备忘</a></p></div></article><article class=media><figure class=media-left><a class=image href=https://blog.imaple.net/posts/auto_acme/><img src=https://raw.githubusercontent.com/iMaple/imaple.github.io/assets/img/19f0a24b34107b97c23f99149f476410-3512c8.webp alt="利用 GitHub Action 自动续签 SSL 证书"></a></figure><div class=media-content><p class=date><time datetime=2020-06-06T16:40:16+08:00>2020-06-06</time></p><p class=title><a href=https://blog.imaple.net/posts/auto_acme/>利用 GitHub Action 自动续签 SSL 证书</a></p><p class=categories><a href=/categories/%e9%83%a8%e7%bd%b2>部署</a></p></div></article><article class=media><div class=media-content><p class=date><time datetime=2020-05-14T20:58:46+08:00>2020-05-14</time></p><p class=title><a href=https://blog.imaple.net/posts/fix_githubusercontent/>解决 raw.githubusercontent.com 无法访问</a></p><p class=categories><a href=/categories/%e5%a4%87%e5%bf%98>备忘</a></p></div></article><article class=media><figure class=media-left><a class=image href=https://blog.imaple.net/posts/algorithm_sort/><img src=https://raw.githubusercontent.com/iMaple/imaple.github.io/assets/img/8d652081532be39da5ad48fabc49b5e8-978a91.webp alt=常见的十个排序算法></a></figure><div class=media-content><p class=date><time datetime=2020-04-18T18:42:15+08:00>2020-04-18</time></p><p class=title><a href=https://blog.imaple.net/posts/algorithm_sort/>常见的十个排序算法</a></p><p class=categories><a href=/categories/%e7%ae%97%e6%b3%95>算法</a></p></div></article></div></div><div class="card widget" data-type=archives><div class=card-content><div class=menu><h3 class=menu-label>归档</h3><ul class=menu-list><li><a class="level is-mobile" href=/archives/#2020-09><span class=level-start><span class=level-item>2020年 9月</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href=/archives/#2020-08><span class=level-start><span class=level-item>2020年 8月</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href=/archives/#2020-06><span class=level-start><span class=level-item>2020年 6月</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href=/archives/#2020-05><span class=level-start><span class=level-item>2020年 5月</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href=/archives/#2020-04><span class=level-start><span class=level-item>2020年 4月</span>
</span><span class=level-end><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href=/archives/#2020-02><span class=level-start><span class=level-item>2020年 2月</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href=/archives/#2020-01><span class=level-start><span class=level-item>2020年 1月</span>
</span><span class=level-end><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href=/archives/#2019-12><span class=level-start><span class=level-item>2019年 12月</span>
</span><span class=level-end><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type=links><div class=card-content><div class=menu><h3 class=menu-label>链接</h3><ul class=menu-list><li><a class="level is-mobile" href=https://gohugo.io target=_blank rel=noopener><span class=level-left><span class=level-item>Hugo</span></span>
<span class=level-right><span class="level-item tag">gohugo.io</span></span></a></li><li><a class="level is-mobile" href=https://github.com/iMaple/hugo-theme-icarus target=_blank rel=noopener><span class=level-left><span class=level-item>icarus</span></span>
<span class=level-right><span class="level-item tag">github.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type=subscribe-email><div class=card-content><div class=menu><h3 class=menu-label>订阅更新</h3><form action=https://feedburner.google.com/fb/a/mailverify method=post target=popupwindow onsubmit='return window.open("https://feedburner.google.com/fb/a/mailverify?uri=imaple","popupwindow","scrollbars=yes,width=550,height=520"),!0'><input type=hidden value=imaple name=uri>
<input type=hidden name=loc value=en_US><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class=input name=email type=email placeholder=Email>
<span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class=control><input class=button type=submit value=订阅></div></div><p class=help>Powered by Google feedburner</p></form></div></div></div></div></div></div></section><footer class=footer><div class=container><div class=level><div class=level-start><a class="footer-logo is-block mb-2" href=/><img src=/img/logo.svg alt="404 Page not found" height=28></a><p class=is-size-7><span>&copy; 2020 - 2024 </span>&nbsp;&nbsp;Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>&nbsp;&&nbsp;<a href=https://github.com/iMaple/hugo-theme-icarus/ target=_blank rel=noopener>Icarus</a><br><span id=busuanzi_container_site_uv>共
<span id=busuanzi_value_site_uv>0</span>
个访客</span></p></div><div class=level-end><div class="field has-addons"><p class=control><a class="button is-transparent is-large" title="Creative Commons" href=https://creativecommons.org/ target=_blank rel=noopener><i class="fab fa-creative-commons"></i></a></p></div></div></div></div></footer><script type=text/javascript src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js></script><script type=text/javascript src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/moment.js/2.26.0/moment-with-locales.min.js></script><script type=text/javascript src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/clipboard.js/2.0.4/clipboard.min.js defer></script><script type=text/javascript src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/highlight.js/9.18.1/highlight.min.js></script><script>moment.locale("zh-cn")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}},toc:{index:!0}}</script><script type=text/javascript src=/js/column.js></script><script type=text/javascript src=/js/animation.js></script><a id=back-to-top title=回到顶端 href=javascript:;><i class="fas fa-chevron-up"></i>
</a><script type=text/javascript src=/js/back2top.js defer></script><script type=text/javascript src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/cookieconsent/3.1.1/cookieconsent.min.js defer></script><script>window.addEventListener("load",()=>{window.cookieconsent.initialise({type:"info",theme:"edgeless",static:!1,position:"bottom-left",content:{message:"此网站使用Cookie来改善您的体验。",dismiss:"知道了！",allow:"允许使用Cookie",deny:"拒绝",link:"了解更多",policy:"Cookie政策",href:"https://www.cookiesandyou.com/"},palette:{popup:{background:"#edeff5",text:"#838391"},button:{background:"#4b81e8"}}})})</script><script type="text/x-mathjax-config;executed=true">
    MathJax.Hub.Config({
      'HTML-CSS': {matchFontHeight: false},
      SVG: {matchFontHeight: false},
      CommonHTML: {matchFontHeight: false},
      tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
    });
    </script><script type=text/javascript src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><script src=https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/smoothscroll/1.4.10/SmoothScroll.min.js async></script><script type=text/javascript src=/js/main.js defer></script><div class=searchbox><div class=searchbox-container><div class=searchbox-header><div class=searchbox-input-container><input class=searchbox-input type=text placeholder=想要查找什么...></div><a class=searchbox-close href=javascript:;>×</a></div><div class=searchbox-body></div></div></div><script type=text/javascript src=/js/insight.js defer></script><script>document.addEventListener("DOMContentLoaded",function(){loadInsight({contentUrl:"/index.json"},{hint:"想要查找什么...",untitled:"(无标题)",posts:"文章",pages:"页面",categories:"分类",tags:"标签"})})</script></body></html>